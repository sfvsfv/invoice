<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>发票申请服务</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>

<!-- 提交成功弹窗（必须放 body 内） -->
<div id="successModal" class="modal" style="display:none;">
    <div class="modal-content">
        <h3>提交成功</h3>
        <p>我们会尽快为您开票。</p>
        <button class="btn" style="margin-top:15px;" onclick="closeSuccess()">知道了</button>
    </div>
</div>

<div class="container">
    <h2>发票申请服务</h2>

    <form id="invoiceForm">
        <label>发票类型 *</label>
        <select name="invoiceType" required>
            <option value="增值税普通电子发票">增值税普通电子发票</option>
        </select>

        <label>开票公司名称 *</label>
        <input type="text" name="companyName" required>

        <label>统一社会信用代码 *</label>
        <input type="text" name="creditCode" required>

        <label>开票项目 *</label>
        <select name="invoiceItem" id="invoiceItem" required></select>

        <label>收发票邮箱 *</label>
        <input type="email" name="invoiceEmail" required>

        <label>购买邮箱/用户名（用于核对是否购买） *</label>
        <input type="email" name="payEmail" required>

        <label>开票金额（元） *</label>
        <input type="number" name="amount" required>

        <label>开票备注</label>
        <textarea name="remark" placeholder="填写备注（可选）"></textarea>

        <button type="submit" class="submit-btn">提交申请</button>
    </form>
</div>

<script>
// 关闭弹窗
function closeSuccess() {
    document.getElementById("successModal").style.display = "none";
}

// 加载开票项目
async function loadItems() {
    const res = await fetch("/api/projects");
    const items = await res.json();
    document.getElementById("invoiceItem").innerHTML =
        items.map(i => `<option value="${i}">${i}</option>`).join("");
}

// 表单提交事件
document.getElementById("invoiceForm").addEventListener("submit", async (e) => {
    e.preventDefault();

    const btn = document.querySelector(".submit-btn");
    btn.disabled = true;
    btn.textContent = "提交中...";

    const formData = Object.fromEntries(new FormData(e.target).entries());

    try {
        const res = await fetch("/api/submit", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(formData)
        });

        await res.json();

        // 显示成功弹窗
        document.getElementById("successModal").style.display = "flex";

        // 清空表单
        e.target.reset();

        // 防止 select 清空后变空
        await loadItems();

    } catch (err) {
        alert("提交失败，请稍后重试");
    } finally {
        btn.disabled = false;
        btn.textContent = "提交申请";
    }
});

// 初始化
loadItems();
</script>

</body>
</html>
